import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as n,a as s,b as a,f as l,e as p,d as k,g as d,r,o as t}from"./app-CySHXAx9.js";const g="/assets/image-20241129141600880-CWT0_jBz.png",o="/assets/image-20241129141638057-DY5D6M8b.png",c="/assets/image-20241129151201860-Cn3a16Hb.png",A="/assets/image-20241129152049131-BCBeQOJW.png",y="/assets/image-20241129154546948-C9kYL9WJ.png",m={},B={class:"MathJax",jax:"SVG",style:{position:"relative"}},Q={style:{"vertical-align":"-0.186ex"},xmlns:"http://www.w3.org/2000/svg",width:"10.965ex",height:"2.09ex",role:"img",focusable:"false",viewBox:"0 -841.7 4846.6 923.7","aria-hidden":"true"},f={class:"MathJax",jax:"SVG",style:{position:"relative"}},v={style:{"vertical-align":"-0.439ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.028ex",height:"1.971ex",role:"img",focusable:"false",viewBox:"0 -677 4874.6 871","aria-hidden":"true"},u={class:"MathJax",jax:"SVG",style:{position:"relative"}},T={style:{"vertical-align":"-0.439ex"},xmlns:"http://www.w3.org/2000/svg",width:"11.028ex",height:"1.946ex",role:"img",focusable:"false",viewBox:"0 -666 4874.6 860","aria-hidden":"true"},D={class:"MathJax",jax:"SVG",style:{position:"relative"}},b={style:{"vertical-align":"-0.05ex"},xmlns:"http://www.w3.org/2000/svg",width:"12.569ex",height:"1.581ex",role:"img",focusable:"false",viewBox:"0 -677 5555.6 699","aria-hidden":"true"};function F(C,i){const e=r("RouteLink");return t(),n("div",null,[i[20]||(i[20]=s("blockquote",null,[s("p",null,[s("strong",null,"背景回顾"),a("：Linux 从一个初始的程序 (状态机) 开始，构建出了整个应用程序世界——通过 fork, execve, exit，我们可以在操作系统中创建出很多并发/并行执行的程序。")])],-1)),s("p",null,[i[2]||(i[2]=s("strong",null,"本讲内容",-1)),i[3]||(i[3]=a("：在我们的状态机模型中，进程的状态由内存和寄存器组成。寄存器是非常明确的，gdb 中 ")),i[4]||(i[4]=s("code",null,"info registers",-1)),i[5]||(i[5]=a(" 即可查看。但进程 “平坦” 的地址空间 (")),s("mjx-container",B,[(t(),n("svg",Q,i[0]||(i[0]=[l('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(944.7,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="mo" transform="translate(1389.3,0)"><path data-c="2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path></g><g data-mml-node="msup" transform="translate(1834,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g><g data-mml-node="mo" transform="translate(3346.3,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(4346.6,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g>',1)]))),i[1]||(i[1]=s("mjx-assistive-mml",{unselectable:"on",display:"inline"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("mn",null,"0"),s("mo",null,"."),s("mo",null,"."),s("mo",null,"."),s("msup",null,[s("mn",null,"2"),s("mrow",{"data-mjx-texclass":"ORD"},[s("mn",null,"64")])]),s("mo",null,"−"),s("mn",null,"1")])],-1))]),i[6]||(i[6]=a(") 里到底有什么，以及我们是否可以 “入侵” 另一个进程的地址空间？"))]),p(" more -"),i[21]||(i[21]=l(`<h2 id="进程的地址空间" tabindex="-1"><a class="header-anchor" href="#进程的地址空间"><span>进程的地址空间</span></a></h2><p>在状态机视角下，我们能够很自然的说出：</p><ul><li>进程(程序) = 内存 + 寄存器 <ul><li>寄存器简单，直接在 <code>gdb</code> 中使用 <code>info registers</code> 就可以查看到当前寄存器的状态</li><li>但是内存呢？并且，到底什么是 <strong>&quot;进程的内存&quot;</strong> ？</li></ul></li></ul><p>我们总是可以将指针赋值为任意一个整数，从而让指针指向对应的地址空间。</p><div class="language-c" data-highlighter="shiki" data-ext="c" data-title="指针赋值" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) main </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;"> 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre></div><p>然后在 C 程序的意义上，我们可以对这个指针进行解引用，从而操作对应的地址空间 (当然，是否被拒绝我们暂时先不管，至少在编程的意义上我们可以这么做)。</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="指针解引用" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Would these operation be legal?</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">a</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // load</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;"> 0x</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // store</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>也许这些操作能够成功，也许会使得程序崩溃 <strong>(几率更大)</strong>。</p><p>这给了我们一个信息 —— <strong>有些地址是可以读的，有些地址是可以写的，有些地址是既不能读又不能写的</strong>...</p><p>那么我们该如何找到相对应的地址空间呢？</p><h3 id="atfai-——-如何查看-linux-上某个进程的地址空间" tabindex="-1"><a class="header-anchor" href="#atfai-——-如何查看-linux-上某个进程的地址空间"><span>ATFAI —— 如何查看 Linux 上某个进程的地址空间?</span></a></h3><blockquote><p>Author: GPT-4o</p></blockquote><p>在 Linux 上，可以通过查看 <code>/proc</code> 目录中的特定文件来了解某一进程的地址空间。每个运行中的进程都有一个对应的目录 <code>/proc/[pid]</code>，其中 <code>[pid]</code> 是进程的 PID (进程 ID)，该目录下包含了关于进程的各种信息。</p><p>查看进程地址空间的步骤：</p><ol><li><p><strong>找到进程的 PID</strong>： 如果你已经知道进程的 PID，可以直接跳到下一步。否则，可以使用 <code>ps</code> 或 <code>pgrep</code> 等命令来查找 PID。例如，假设你想查看名为 <code>my_program</code> 的进程：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">pgrep</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> my_program</span></span></code></pre></div></li><li><p><strong>查看 <code>/proc/[pid]/maps</code> 文件</strong>： <code>/proc/[pid]/maps</code> 文件列出了进程的内存映射信息，显示了进程如何分配其地址空间。每个条目包含一个内存区域的起始和结束地址、权限、映射的文件等。</p><p>假设你要查看进程 PID 为 <code>1234</code> 的地址空间，可以运行以下命令：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/1234/maps</span></span></code></pre></div><p>你会看到类似以下的输出：</p><div class="language-less line-numbers-mode" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">00400000-00452000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-xp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00651000-00652000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00051000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00652000-00653000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00052000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7f9e00000000-7f9e00200000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0 </span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>每行表示一个内存映射区域。</li><li>第一列是地址范围，例如 <code>00400000-00452000</code> 表示这个区域从 <code>0x00400000</code> 到 <code>0x00452000</code>。</li><li>第二列是权限标志，例如 <code>r-xp</code> 表示可读、可执行、私有映射。</li><li>第三列是偏移量。</li><li>第四列是设备号。</li><li>第五列是 <code>inode</code> 编号。</li><li>第六列是映射的文件路径，如果这个区域映射了某个文件的话。</li></ul></li><li><p><strong>查看 <code>/proc/[pid]/maps</code> 文件中的特定区域</strong>：</p><ul><li><code>r</code> 表示可读（read）。</li><li><code>w</code> 表示可写（write）。</li><li><code>x</code> 表示可执行（execute）。</li><li><code>p</code> 表示私有（private），即写时复制（copy-on-write）。</li></ul></li></ol><p>根据这些信息，你可以了解进程的不同内存区域，如代码段、堆栈、堆、共享库、映射文件等。</p><p>示例输出解释：</p><p>以下是一个 <code>maps</code> 文件的简化示例：</p><div class="language-less line-numbers-mode" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">00400000-00452000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-xp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00651000-00652000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00051000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00652000-00653000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00052000 08:01 1234567 /</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">path</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/to/program</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7f9e00000000-7f9e00200000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0 </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7f9e00000000-7f9e00200000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0 </span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>00400000-00452000 r-xp</code>：该区域是程序的代码段，包含只读且可执行的代码。</li><li><code>00651000-00652000 r--p</code>：该区域是只读的数据段。</li><li><code>7f9e00000000-7f9e00200000 rw-p</code>：该区域是堆栈或动态分配的内存区域。</li></ul><p>查看进程的完整内存映射（包括共享库、堆栈等）：</p><p>要获得进程地址空间的详细信息，包括共享库、堆、栈等，你可以使用以下命令：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/[pid]/maps</span></span></code></pre></div><p>或者用 <code>less</code> 等分页工具查看：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">less</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/[pid]/maps</span></span></code></pre></div><p>其他相关信息：</p><ul><li><p><strong><code>/proc/[pid]/smaps</code></strong>：如果你需要更详细的内存使用情况（例如，每个区域的实际物理内存使用情况），可以查看 <code>smaps</code> 文件：</p><div class="language-bash" data-highlighter="shiki" data-ext="bash" data-title="bash" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">cat</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> /proc/[pid]/smaps</span></span></code></pre></div></li></ul><p><code>smaps</code> 提供了每个内存区域的详细统计信息，包括物理内存的使用、共享内存等。</p><p>总结：</p><ul><li>使用 <code>/proc/[pid]/maps</code> 可以查看进程的内存映射，帮助你了解进程如何分配和使用内存空间。</li><li>对于更详细的内存使用情况，查看 <code>/proc/[pid]/smaps</code>。</li></ul><p>通过这些方法，你可以全面了解某个进程的地址空间。</p><h3 id="进程的地址空间-——-全貌" tabindex="-1"><a class="header-anchor" href="#进程的地址空间-——-全貌"><span>进程的地址空间 —— 全貌</span></a></h3><p>在执行了 <code>cat /proc/[pid]/maps</code> 命令或者 <code>pmap</code> 命令来查看指定进程的地址空间信息之后，我们可以看到该进程的当前已分配内存映射段的总览：</p><div class="language-less line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="less" data-title="less" style="--vp-collapsed-lines:20;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// maps file ver.</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">6096</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">e05ef000-6096e0606000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 08:03 3058736                    /usr/bin/zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e0606000-6096e06c4000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-xp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00017000 08:03 3058736                    /usr/bin/zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e06c4000-6096e06df000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 000d5000 08:03 3058736                    /usr/bin/zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e06df000-6096e06e1000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 000ef000 08:03 3058736                    /usr/bin/zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e06e1000-6096e06e7000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 000f1000 08:03 3058736                    /usr/bin/zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e06e7000-6096e06fb000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0 </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">6096e1a10000-6096e1cd0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">heap</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// hidden lines...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7fff0ef46000-7fff0efa0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">stack</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7fff0efda000-7fff0efde000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vvar</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">7fff0efde000-7fff0efe0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-xp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vdso</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// negtive number?</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ffffffffff600000-ffffffffff601000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> --xp 00000000 00:00 0                  [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vsyscall</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// pmap command ver.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">1995:   /usr/bin/zsh -</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1db21000     92K r---- zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1db38000    760K </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-- zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1dbf6000    108K r---- zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1dc11000      8K r---- zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1dc13000     24K rw--- zsh</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1dc19000     80K rw---   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00005b3a1f7f0000   2076K rw---   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// hidden lines...</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">0000700364d23000     24K rw---   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00007ffeae233000    292K rw---   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">stack</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00007ffeae36f000     16K r----   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">00007ffeae373000      8K </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-x</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">--   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// negtive number?</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ffffffffff600000      4K --x--   [ </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">anon</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ]</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> total            19872K</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><blockquote><p>各列的介绍见上方 ChatGPT 提供的解释。</p></blockquote><p>正如我们猜想的一样，各段地址空间存在不同的权限。</p><p>同时，你可能注意到有一些特殊的地址空间，让我们看看 GPT 是怎么回答的。</p><div class="hint-container info"><p class="hint-container-title">特定区域的作用</p><blockquote><p>Author: GPT-4o</p></blockquote><p>当你查看 <code>/proc/&lt;pid&gt;/maps</code> 文件时，看到的这些内存区域代表了进程的虚拟地址空间的不同部分。每个区域都有不同的权限和用途。我们可以逐个分析你提供的几个区域：</p><ol><li><strong>[heap] 区域</strong></li></ol><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">6096</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">e1a10000-6096e1cd0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">heap</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><ul><li><strong>地址范围</strong>：<code>6096e1a10000</code> 到 <code>6096e1cd0000</code></li><li><strong>权限</strong>：<code>rw-p</code>，意味着这个区域是 <strong>读写</strong> 权限的，且是 <strong>私有的</strong>（<code>p</code> 表示 private）。</li><li><strong>用途</strong>：该区域是程序的堆内存区域（<code>[heap]</code>）。堆用于动态内存分配（例如 <code>malloc()</code>）。当程序运行时，这个区域会根据需要动态扩展。</li></ul><ol start="2"><li><strong>[stack] 区域</strong></li></ol><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">7</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fff0ef46000-7fff0efa0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rw-p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">stack</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><ul><li><strong>地址范围</strong>：<code>7fff0ef46000</code> 到 <code>7fff0efa0000</code></li><li><strong>权限</strong>：<code>rw-p</code>，同样是 <strong>读写</strong> 且 <strong>私有</strong> 的权限。</li><li><strong>用途</strong>：这个区域是 <strong>栈</strong> 内存（<code>[stack]</code>），用于存储局部变量、函数调用信息和返回地址等。栈的大小通常在程序启动时确定，并且会随着函数调用的深度而增长或缩小。</li></ul><ol start="3"><li><strong>[vvar] 区域</strong></li></ol><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">7</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fff0efda000-7fff0efde000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r--p</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vvar</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><ul><li><strong>地址范围</strong>：<code>7fff0efda000</code> 到 <code>7fff0efde000</code></li><li><strong>权限</strong>：<code>r--p</code>，表示只读且私有。</li><li><strong>用途</strong>：这个区域是 <strong>vvar</strong>（virtual variable）内存区域。它存储了操作系统为了系统调用（如 <code>gettimeofday()</code>）而维护的 <strong>共享</strong> 数据 (将操作系统里面的 (只读) 数据通过内存共享给进程，使系统调用无需陷入内核中，提高效率) 。这个区域通常用于实现一些 <strong>内核和用户空间</strong> 共享的变量。</li></ul><ol start="4"><li><strong>[vdso] 区域</strong></li></ol><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">7</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">fff0efde000-7fff0efe0000 </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">r-xp</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> 00000000 00:00 0                          [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vdso</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><ul><li><strong>地址范围</strong>：<code>7fff0efde000</code> 到 <code>7fff0efe0000</code></li><li><strong>权限</strong>：<code>r-xp</code>，表示 <strong>只读</strong> 和 <strong>可执行</strong> 权限，且是私有的。</li><li><strong>用途</strong>：这个区域是 <strong>vdso</strong>（virtual dynamic shared object）内存区域。它存储一些操作系统提供的函数，这些函数通常是用于实现系统调用的包装器。由于这些函数是 <strong>预加载</strong> 到用户空间的，因此访问这些函数的速度更快，避免了频繁的上下文切换到内核空间。</li></ul><ol start="5"><li><strong>[vsyscall] 区域</strong></li></ol><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ffffffffff600000-ffffffffff601000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> --xp 00000000 00:00 0                  [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vsyscall</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><ul><li><strong>地址范围</strong>：<code>ffffffffff600000</code> 到 <code>ffffffffff601000</code></li><li><strong>权限</strong>：<code>--xp</code>，表示 <strong>不可读不可写</strong>，但是是 <strong>可执行</strong> 且 <strong>私有</strong> 的。</li><li><strong>用途</strong>：这是 <strong>vsyscall</strong>（virtual system call）区域。与 <code>vdso</code> 类似，<code>vsyscall</code> 是操作系统为提高系统调用效率而设立的特殊内存区域。系统调用（例如 <code>getpid()</code>）可以通过直接跳转到 <code>vsyscall</code> 区域来执行，而 <strong>不需要进入内核模式</strong>。<code>vsyscall</code> 主要在较旧的 Linux 系统上使用，在较新的系统中，它已经被 <code>vdso</code> 所取代。</li></ul><ol start="6"><li>关于负数的符号问题</li></ol><p>你提到的 &quot;负数&quot; 是指以下这行：</p><div class="language-less" data-highlighter="shiki" data-ext="less" data-title="less" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ffffffffff600000-ffffffffff601000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> --xp 00000000 00:00 0                  [</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">vsyscall</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">]</span></span></code></pre></div><p>这个 <code>ffffffffff600000</code> 地址范围看起来像是“负数”，但其实它是一个 <strong>高位地址</strong>，在 64 位系统中，虚拟地址空间的 <strong>高端是为内核空间保留的，而低端则用于用户空间</strong>。因为 64 位系统支持非常大的地址空间，它将地址空间划分为多个部分：</p><ul><li><strong>内核空间</strong>：从 <code>0xffff800000000000</code> 到 <code>0xffffffffffffffff</code>（这些地址通常用于内核和硬件映射等）。</li><li><strong>用户空间</strong>：从 <code>0x0000000000000000</code> 到 <code>0x7fffffffffffffff</code>（这些地址是应用程序的虚拟地址空间）。</li><li>??? : 从 <code>0x7fffffffffffffff</code> 到 <code>0xffff800000000000</code> 这段区域是拿来干什么的呢？</li></ul><p>在 <code>/proc/&lt;pid&gt;/maps</code> 中显示的这些高地址（如 <code>ffffffffff600000</code>）<strong>实际上是内核空间的一部分</strong>，但它们仍然在进程的虚拟地址空间中列出，以便能查看到内核级的资源（如 <code>vsyscall</code>）。</p><ol start="7"><li>总结</li></ol><ul><li><strong>堆 (<code>[heap]</code>)</strong> 和 <strong>栈 (<code>[stack]</code>)</strong> 区域是进程的内存分配区域，分别用于动态内存和局部变量。</li><li><strong><code>[vvar]</code></strong> 和 <strong><code>[vdso]</code></strong> 区域与操作系统提供的系统调用包装函数和共享变量相关。</li><li><strong><code>[vsyscall]</code></strong> 区域曾用于提高系统调用的效率，现代系统中可能已被 <code>vdso</code> 取代。</li><li>高地址范围（如 <code>ffffffffff600000</code>）并不是负数，而是 <strong>内核空间</strong> 的虚拟地址区域。</li></ul><p>这些内存区域的分配和权限设置帮助操作系统有效地管理进程的内存。</p></div><h3 id="系统调用-——-一定需要-syscall-吗" tabindex="-1"><a class="header-anchor" href="#系统调用-——-一定需要-syscall-吗"><span>🌶️ 系统调用 —— 一定需要 <code>syscall</code> 吗？</span></a></h3>`,39)),s("p",null,[i[8]||(i[8]=a("详见 ")),k(e,{to:"/zh/note/os/Virtualization/do-we-always-need-syscall.html"},{default:d(()=>i[7]||(i[7]=[a("Do we always need "),s("code",null,"syscall",-1),a(" ?")])),_:1})]),i[22]||(i[22]=l(`<h3 id="管理进程的地址空间" tabindex="-1"><a class="header-anchor" href="#管理进程的地址空间"><span>管理进程的地址空间</span></a></h3><p>还是从状态机的视角来看：</p><ul><li>地址空间 = 带 <strong>访问权限</strong> 的内存段 <ul><li>不存在 (不可访问)</li><li>不存在 (可读/写/执行)</li></ul></li><li>管理 = <strong>增加/删除/修改一段可访问的内存</strong></li></ul><p>我们可以使用 <code>gdb</code> 调试一下程序，查看一下程序内的地址空间分配情况:</p><ol><li><p><code>gdb [OPTIONS] FILE_NAME</code> 开始使用 <code>gdb</code> 进行调试</p></li><li><p><code>starti</code> 执行完起始的第一条语句后暂停执行</p></li><li><p><code>info proc mappings</code> 查看进程的 <code>maps</code> 文件信息</p></li><li><p><code>info inferiors</code> 查看当前正在被 <code>gdb</code> 调试的进程信息</p><blockquote><p>&quot;Inferior&quot; is a general term to mean &quot;something that you are using gdb to debug&quot;</p></blockquote></li><li><p><code>!pmap [pid]</code> 查看 (更加) 人类可读的地址空间分配信息</p></li></ol><p>我们随意测试了一个程序，在执行 <code>malloc</code> 前后查看了一下进程对应的地址空间信息：(结果不在同一次调试中呈现，因此进程号不相同)</p><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="hello.c" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Hello World</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mem </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">malloc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1000000</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">LL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;We&#39;ve allocated memory!</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    free</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(mem);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><figure><img src="`+g+'" alt="执行 malloc 之前的地址空间状态" tabindex="0" loading="lazy"><figcaption>执行malloc之前的地址空间状态</figcaption></figure><figure><img src="'+o+`" alt="执行 malloc 之后的状态" tabindex="0" loading="lazy"><figcaption>执行malloc之后的状态</figcaption></figure><p>我们发现进程当前持有的地址空间总数 <strong>变大</strong> 了。那么一定存在一种机制，能够动态修改进程的地址空间映射。</p><div class="hint-container info"><p class="hint-container-title">🤔</p><p>究竟是哪种 (些) 指令能够动态修改这类信息呢？</p></div><p>答案自然是我们的 <code>syscall</code> 了。<code>mov</code>、<code>ret</code> 等基本指令(至少在用户态进程中，暂时没求证过的话不能说太死)完全不可能修改这些信息。那么又是哪种系统调用能够完成这件事情呢？</p><h3 id="mmap-memory-map-系统调用" tabindex="-1"><a class="header-anchor" href="#mmap-memory-map-系统调用"><span><code>mmap</code> (Memory Map) 系统调用</span></a></h3><blockquote><p>详细手册可使用 <code>man 2 mmap</code> 查看。</p></blockquote><p>Linux 中为我们提供了 <code>mmap</code> 这一系统调用来对进程地址空间映射数据做增删改操作。</p><p>行为简要描述：在状态机状态上增加/删除/修改一段可访问的内存</p><ul><li><code>MAP_ANONYMOUS</code>: 匿名 (申请) 内存</li><li><code>fd</code>: 把文件 “搬到” 进程地址空间中 (例子：加载器)</li><li>更多的行为请参考手册 (复杂性暴增)</li></ul><div class="language-c line-numbers-mode" data-highlighter="shiki" data-ext="c" data-title="mmap API" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 映射</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">mmap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> prot</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> flags</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">           int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> fd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> off_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> offset</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> munmap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 修改映射权限</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mprotect</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">addr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> length</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> prot</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">个人遇到的一些小插曲</p><p>在参考手册自行玩一玩示例程序的过程中，似乎出现了一些小问题：</p><div class="language-c line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="c" data-title="示例程序" style="--vp-collapsed-lines:20;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;unistd.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;stdint.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;stdio.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;stdlib.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;sys/mman.h&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#define</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GiB</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1024</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">LL</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1024</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    volatile</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint8_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mmap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        NULL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">        5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        PROT_WRITE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PROT_EXEC,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 没有设置读权限</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        MAP_ANONYMOUS </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">|</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MAP_PRIVATE,</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 设置匿名与私有属性</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    );</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;mmap: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%lx</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uintptr_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)p);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ((</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">intptr_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        perror</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot map&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">        exit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Read get: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB));</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Read get: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB));</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    printf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Read get: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">%d</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GiB));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><div class="language-less line-numbers-mode" data-highlighter="shiki" data-ext="less" data-title="执行结果" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">mmap: 77354ea00000</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Read get: 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Read get: 2</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">Read get: 3</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>😱 为什么不设置读权限程序也能正常运行，而不是遇到 <em>Segmentation Fault</em> 呢？</p><p>首先我使用 <code>gdb</code> 调试了一下：</p><figure><img src="`+c+'" alt="使用 gdb 调试得到的进程地址空间映射信息" tabindex="0" loading="lazy"><figcaption>使用gdb调试得到的进程地址空间映射信息</figcaption></figure><p>这块 5 GiB 内存段的权限设置并没有任何问题。</p><p>然后我试着把权限设置为了 <code>PROT_NONE</code>, 没有任意权限，很自然地崩溃了。</p><figure><img src="'+A+'" alt="PROC_NONE" tabindex="0" loading="lazy"><figcaption>将权限设置成 PROT_NONE 之后的结果</figcaption></figure><p>同理，<code>PROT_EXEC</code> 也不行。最后就到了 <code>PROT_WRITE</code> ，结果发现 <strong>只需要设置写权限</strong> 就能够正常运行。</p><div style="text-align:center;"><p><s>可能主要和 <strong>内存保护模型</strong> 以及 <strong>执行权限的特殊处理</strong> 有关，ATFAI, RTFM, RTFW 任君挑选</s></p></div></div><h4 id="example-1-申请大量内存空间" tabindex="-1"><a class="header-anchor" href="#example-1-申请大量内存空间"><span>Example 1: 申请大量内存空间</span></a></h4><ul><li>瞬间完成内存分配 <ul><li><code>mmap</code>/<code>munmap</code> 为 <code>malloc</code>/<code>free</code> 提供了机制</li><li><code>libc</code> 的大 <code>malloc</code> 会直接调用一次 <code>mmap</code> 实现</li></ul></li><li>不妨 <code>strace</code>/<code>gdb</code> 看一下<br><img src="'+y+`" alt="libc 中的 malloc" title="libc中的malloc" loading="lazy"></li></ul><h4 id="example-2-everything-is-a-file" tabindex="-1"><a class="header-anchor" href="#example-2-everything-is-a-file"><span>Example 2: Everything is a file</span></a></h4><ul><li>映射大文件、只访问其中的一小部分</li></ul><div class="language-python line-numbers-mode" data-highlighter="shiki" data-ext="python" data-title="检查大文件的前512字节" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">with</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;/dev/sda&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;rb&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">as</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> fp:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    mm </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> mmap.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">mmap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(fp.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">fileno</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(),</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">                   prot</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">mmap.</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">PROT_READ</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">length</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">128</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 30</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    hexdump.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">hexdump</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(mm[:</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">512</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="入侵-进程的地址空间" tabindex="-1"><a class="header-anchor" href="#入侵-进程的地址空间"><span>&quot;入侵&quot; 进程的地址空间</span></a></h2><div class="hint-container info"><p class="hint-container-title">回顾：状态机模型</p><p><strong>进程 (状态机) 在 “无情执行指令的机器” 上执行</strong> :</p><ul><li>状态机是一个 <strong>封闭世界</strong> (基本假设)</li><li>但如果 <strong>允许一个进程对其他进程的地址空间有访问权</strong> ？(打破基本假设) <ul><li>意味着可以任意改变另一个程序的行为 <ul><li>听起来就很 cool</li></ul></li></ul></li></ul></div><p><strong>一些 “入侵” 进程地址空间的例子</strong>:</p><ul><li>调试器 (<code>gdb</code>) <ul><li><code>gdb</code> 可以任意观测和修改程序的状态 <ul><li>将被调试进程的信息搬到自己的地址空间内</li></ul></li></ul></li><li><em>Profiler</em> (<code>perf</code>) <ul><li><a href="https://jyywiki.cn/OS/2024/labs/M3.md" target="_blank" rel="noopener noreferrer">M3</a> 中借助它理解程序的性能瓶颈</li></ul></li></ul><p>不知道你是否用过一些游戏修改器，例如 Cheat Engine、八门神器、葫芦侠修改器、烧饼修改器等等。实际上游戏修改器也是通过入侵游戏进程的地址空间来实现修改的。</p><div class="hint-container tip"><p class="hint-container-title">修改游戏中的金钱</p><p>假如说我们想要修改游戏进程中的金钱数，应该怎么做？</p><ul><li>在 <strong>允许一个进程对其他进程的地址空间有访问权</strong> 的情况下，我们可以扫描游戏进程的地址空间</li><li>看看有没有值 = 待查找值的地址</li><li>如果找到了 <strong>比较少</strong> 的地址，进行修改；否则就尝试着 <strong>缩小范围</strong><ul><li>怎么缩小范围呢？ <ul><li>观察状态机的状态改变轨迹就可以了！</li></ul></li></ul></li></ul></div><p>实际上我们在使用游戏修改器的时候，就是使用了 <strong>查找 + Filter</strong> 的方式来找到待修改的地址的！</p>`,31)),s("ul",null,[s("li",null,[i[11]||(i[11]=a("进入游戏时 ")),s("mjx-container",f,[(t(),n("svg",v,i[9]||(i[9]=[l('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(466,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mi" transform="translate(1038,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(1818.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(2874.6,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path></g></g></g>',1)]))),i[10]||(i[10]=s("mjx-assistive-mml",{unselectable:"on",display:"inline"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("mi",null,"e"),s("mi",null,"x"),s("mi",null,"p"),s("mo",null,"="),s("mn",null,"4950")])],-1))])]),s("li",null,[i[14]||(i[14]=a("打了个怪 ")),s("mjx-container",u,[(t(),n("svg",T,i[12]||(i[12]=[l('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(466,0)"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path></g><g data-mml-node="mi" transform="translate(1038,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path></g><g data-mml-node="mo" transform="translate(1818.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(2874.6,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path></g></g></g>',1)]))),i[13]||(i[13]=s("mjx-assistive-mml",{unselectable:"on",display:"inline"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("mi",null,"e"),s("mi",null,"x"),s("mi",null,"p"),s("mo",null,"="),s("mn",null,"5100")])],-1))])]),s("li",null,[i[17]||(i[17]=a("符合 ")),s("mjx-container",D,[(t(),n("svg",b,i[15]||(i[15]=[l('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path></g><g data-mml-node="mo" transform="translate(2277.8,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(3555.6,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"></path></g></g></g>',1)]))),i[16]||(i[16]=s("mjx-assistive-mml",{unselectable:"on",display:"inline"},[s("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[s("mn",null,"4950"),s("mo",{stretchy:"false"},"→"),s("mn",null,"5100")])],-1))]),i[18]||(i[18]=a(" 变化的内存地址是很少的 ")),i[19]||(i[19]=s("ul",null,[s("li",null,"好了，出门就是满级了")],-1))])]),i[23]||(i[23]=l(`<h2 id="改变进程对时间的感知" tabindex="-1"><a class="header-anchor" href="#改变进程对时间的感知"><span>改变进程对时间的感知</span></a></h2><p><strong>程序 = 状态机</strong> :</p><ul><li>“计算指令” 是不能感知时间的 <ul><li><em>spin count</em> 计时会出现 “机器变快，游戏没法玩” 的情况</li><li><strong><code>syscall</code> 是感知时间的唯一方法</strong></li></ul></li></ul><p>所以如果要改变进程对时间的认知，我们可以 <strong>“劫持” 和时间相关的 <code>syscall</code>/库函数</strong></p><ul><li>改变程序对时间的认知</li><li>就像手表调快/慢了一样</li></ul><p>比如下面的例子就劫持了程序中的 <code>gettimeofday</code> 这一与事件相关的函数。</p><div class="language-python line-numbers-mode has-collapsed-lines collapsed" data-highlighter="shiki" data-ext="python" data-title="使用gdb实现对时间的hack" style="--vp-collapsed-lines:20;--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> gdb</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">import</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> datetime</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ratio </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> float</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">parse_and_eval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;$gear_ratio&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"># Get the current time</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">start </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> datetime.datetime.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> hacked_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">():</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    now </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> datetime.datetime.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    # The speed of the clock is adjusted</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    t </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> start </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">+</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (now </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> start) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ratio</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    tv_sec </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(t.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">timestamp</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">())</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    tv_usec </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> t.microsecond</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (tv_sec, tv_usec)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SetTimevalBreakpoint</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gdb</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Breakpoint</span><span style="--shiki-light:#C18401;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;"> __init__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        # 在 gettimeofday 处打断点</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">        super</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(SetTimevalBreakpoint, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">__init__</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &#39;gettimeofday&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#D19A66;">BP_BREAKPOINT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">            internal</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">False</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    def</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> stop</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-light-font-style:inherit;--shiki-dark:#E5C07B;--shiki-dark-font-style:italic;">self</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">):</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        # 计算 变速之后的时间</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        tv_sec, tv_usec </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;"> hacked_time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        # core implementation: Replace the function body</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span></span>
<span class="line"><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">            &#39;set *(struct timeval *)($rdi) = {{ {}, {} }}&#39;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                .</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">format</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tv_sec, tv_usec)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        )</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;set $rax = 0&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;return&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> False</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  # Continue execution</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">SetTimevalBreakpoint</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">gdb.</span><span style="--shiki-light:#383A42;--shiki-dark:#61AFEF;">execute</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;run&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="collapsed-lines"></div></div><blockquote><p>在上面的代码中，我们使用了 &quot;钩子函数&quot; (<em>hook function</em>) 来钩住函数的执行，然后就可以 &quot;劫持&quot; 相关的代码了...</p></blockquote><p>我们其实可以认为 “劫持代码” 的本质是 <em>debugger</em> 行为</p><ul><li>游戏也是程序，也是状态机</li><li>外挂就是 “为这个游戏专门设计的 <code>gdb</code>”</li></ul><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>状态机的视角自然地将我们引入 “内存到底是什么” 的问题——它的答案同样也很自然：带有 <strong>访问权限</strong> 控制的连续 <strong>内存段</strong> 。我们可以通过 <code>mmap</code>、<code>munmap</code>、<code>mprotect</code> 三个系统调用调整状态机的地址空间，包括分配匿名的内存、映射文件内容到内存、修改访问权限等。更有趣的是操作系统有 “能够实现一切应用程序” 的需求，调试器也不在话下——这也给了我们 &quot;入侵&quot; 其他进程地址空间的机制。</p>`,12))])}const H=h(m,[["render",F],["__file","address-space-of-process.html.vue"]]),M=JSON.parse('{"path":"/zh/note/os/Virtualization/address-space-of-process.html","title":"进程的地址空间","lang":"zh-CN","frontmatter":{"title":"进程的地址空间","order":15,"icon":"memory","categories":["操作系统"],"tags":["进程","地址空间"],"description":"背景回顾：Linux 从一个初始的程序 (状态机) 开始，构建出了整个应用程序世界——通过 fork, execve, exit，我们可以在操作系统中创建出很多并发/并行执行的程序。 本讲内容：在我们的状态机模型中，进程的状态由内存和寄存器组成。寄存器是非常明确的，gdb 中 info registers 即可查看。但进程 “平坦” 的地址空间 () ...","head":[["meta",{"property":"og:url","content":"https://vuepress-theme-hope-docs-demo.netlify.app/zh/note/os/Virtualization/address-space-of-process.html"}],["meta",{"property":"og:site_name","content":"文档演示"}],["meta",{"property":"og:title","content":"进程的地址空间"}],["meta",{"property":"og:description","content":"背景回顾：Linux 从一个初始的程序 (状态机) 开始，构建出了整个应用程序世界——通过 fork, execve, exit，我们可以在操作系统中创建出很多并发/并行执行的程序。 本讲内容：在我们的状态机模型中，进程的状态由内存和寄存器组成。寄存器是非常明确的，gdb 中 info registers 即可查看。但进程 “平坦” 的地址空间 () ..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-11-29T10:24:26.000Z"}],["meta",{"property":"article:tag","content":"进程"}],["meta",{"property":"article:tag","content":"地址空间"}],["meta",{"property":"article:modified_time","content":"2024-11-29T10:24:26.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"进程的地址空间\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-11-29T10:24:26.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"codePJCP2\\",\\"url\\":\\"https://docs.pjcp2-personal.cn/zh/\\"}]}"]]},"headers":[{"level":2,"title":"进程的地址空间","slug":"进程的地址空间","link":"#进程的地址空间","children":[{"level":3,"title":"ATFAI —— 如何查看 Linux 上某个进程的地址空间?","slug":"atfai-——-如何查看-linux-上某个进程的地址空间","link":"#atfai-——-如何查看-linux-上某个进程的地址空间","children":[]},{"level":3,"title":"进程的地址空间 —— 全貌","slug":"进程的地址空间-——-全貌","link":"#进程的地址空间-——-全貌","children":[]},{"level":3,"title":"🌶️ 系统调用 —— 一定需要 syscall 吗？","slug":"系统调用-——-一定需要-syscall-吗","link":"#系统调用-——-一定需要-syscall-吗","children":[]},{"level":3,"title":"管理进程的地址空间","slug":"管理进程的地址空间","link":"#管理进程的地址空间","children":[]},{"level":3,"title":"mmap (Memory Map) 系统调用","slug":"mmap-memory-map-系统调用","link":"#mmap-memory-map-系统调用","children":[]}]},{"level":2,"title":"\\"入侵\\" 进程的地址空间","slug":"入侵-进程的地址空间","link":"#入侵-进程的地址空间","children":[]},{"level":2,"title":"改变进程对时间的感知","slug":"改变进程对时间的感知","link":"#改变进程对时间的感知","children":[]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1732875866000,"updatedTime":1732875866000,"contributors":[{"name":"codePJCP2","email":"159783914+codePJCP2@users.noreply.github.com","commits":1}]},"readingTime":{"minutes":15.68,"words":4704},"filePathRelative":"zh/note/os/Virtualization/address-space-of-process.md","localizedDate":"2024年11月29日","autoDesc":true}');export{H as comp,M as data};
